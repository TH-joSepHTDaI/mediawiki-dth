# ---------------------------------------------------------
# Redirect all HTTP traffic to HTTPS
# ---------------------------------------------------------
server {
    listen 80; # Listen for incoming HTTP requests on port 80
    server_name media-wiki.example.com; # Domain name handled by this server block

    # Redirect every HTTP request to the HTTPS version of the same URL
    return 301 https://$host$request_uri;
}

# ---------------------------------------------------------
# HTTPS server block — handles encrypted connections
# ---------------------------------------------------------
server {
    listen 443 ssl; # Listen on port 443 (HTTPS) with SSL enabled
    server_name media-wiki.example.com; # Domain name for this virtual host

    # -----------------------------------------------------
    # SSL certificate configuration
    # -----------------------------------------------------
    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    # Basic SSL security settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # -----------------------------------------------------
    # Reverse proxy configuration — forward to MediaWiki
    # -----------------------------------------------------
    location / {
        proxy_pass http://wiki-app:80;  # Forward requests to MediaWiki container on port 80
        
        # Preserve important client and protocol information
        proxy_set_header Host $host;             # Pass the original Host header to the backend
        proxy_set_header X-Real-IP $remote_addr; # Forward the client's real IP address
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Keep proxy chain of client IPs
        proxy_set_header X-Forwarded-Proto https; # Tell MediaWiki the original request used HTTPS
    }
}
